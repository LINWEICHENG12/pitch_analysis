# 手軸運動分析系統開發記錄

## 1. 系統概述

這是一個基於 Python 的手軸運動分析系統，使用 MediaPipe 進行骨架偵測，並提供運動分析和視覺化功能。

### 1.1 主要功能
- 影片載入和播放
- 手軸骨架偵測和追蹤
- 運動速度計算
- 角度分析
- 軌跡視覺化
- 數據記錄和報告生成

### 1.2 使用的技術
- OpenCV (cv2)：影片處理和圖像顯示
- MediaPipe：骨架偵測
- NumPy：數值計算
- Matplotlib：數據視覺化
- Python 標準庫：檔案處理、時間處理等

## 2. 開發歷程

### 2.1 初始版本
- 實現基本的影片載入和播放功能
- 整合 MediaPipe 進行骨架偵測
- 實現基本的手軸追蹤

### 2.2 功能擴展
- 添加速度計算功能
- 實現角度分析
- 添加軌跡繪製功能
- 實現數據記錄功能

### 2.3 錯誤修正
1. 主程式崩潰問題
   - 問題：重複初始化 MediaPipe Pose
   - 解決：移除多餘的初始化，統一在類別初始化時完成
   - 影響：提高程式穩定性

2. 座標轉換問題
   - 問題：浮點數座標導致繪圖錯誤
   - 解決：使用 int() 轉換座標值
   - 影響：提高繪圖準確性

3. 錯誤處理改進
   - 問題：缺乏適當的錯誤處理機制
   - 解決：添加 try-except 區塊
   - 影響：提高程式穩定性，更好的錯誤提示

4. 速度計算校正
   - 問題：速度值顯示異常高（數百公尺/秒）
   - 解決：
     - 修正時間單位轉換
     - 分開計算手掌和手肘速度
     - 實現正確的像素到公尺轉換
   - 影響：得到更準確的速度值

5. 像素比例校正
   - 初始值：296 像素/公尺
   - 最終值：346.8 像素/公尺
   - 方法：
     - 使用已知距離（1公尺）作為參考
     - 測量影片畫面中的像素數
     - 計算比例：像素/公尺 = 346.8
   - 影響：
     - 更準確的速度計算
     - 更精確的距離測量
     - 更真實的運動分析

6. 速度追蹤改進
   - 改進內容：
     - 分開追蹤手掌和手肘速度
     - 添加個別速度歷史記錄
     - 實現各關節的獨立視覺化
   - 效益：
     - 更詳細的運動分析
     - 更好地理解關節力學
     - 更清晰的運動模式視覺化

7. 介面顯示優化
   - 改進內容：
     - 將所有顯示文字改為英文
     - 改進圖表可讀性
     - 添加詳細統計資訊顯示
   - 功能：
     - 即時速度顯示
     - 最大和平均速度追蹤
     - 角度測量
     - 完整的分析報告

8. 手肘角度計算異常
   - 問題：手臂完全伸直時，顯示角度卻只有個位數，與實際人體動作不符。
   - 原因：原本角度計算向量方向錯誤，未以肘為端點計算肩-肘與腕-肘的夾角。
   - 修正：
     - 以肘為端點，分別計算肩→肘（上臂）與腕→肘（前臂）向量
     - 使用這兩個向量的夾角作為手肘角度
     - 這樣手臂完全伸直時角度接近180度，彎曲時小於180度
   - 影響：角度顯示更符合人體工學與實際動作

9. 角速度跨越±180度時跳變
   - 問題：肩帶或髖帶旋轉超過180度時，角度曲線連續但角速度會突然變成負值或跳變，導致圖表不連續。
   - 原因：傳統角速度計算只用連續角度差，未考慮角度的週期性（360度循環）。
   - 解決方法：
     - 角速度計算時，改用「模360度的最短圓弧差」公式：
       ```python
       def angle_diff_deg(a, b):
           d = a - b
           d = (d + 180) % 360 - 180
           return d
       ```
     - 這樣即使角度跨越±180度，角速度也會連續且物理意義正確。
   - 影響：角速度圖表更平滑、連續，能正確反映實際動作變化。

### 2.4 使用者介面改進
1. 顯示優化
   - 添加更多影片資訊顯示
   - 調整文字位置和大小
   - 使用白色文字提高可讀性

2. 控制功能
   - 播放控制（暫停/繼續）
   - 速度調整
   - 重置功能
   - 記錄控制

### 2.5 技術實現細節
1. 速度計算方法
```python
# 計算像素距離
dx = abs(當前位置 - 前一個位置)
dy = abs(當前位置 - 前一個位置)
距離像素 = math.sqrt(dx**2 + dy**2)

# 轉換為公尺
距離公尺 = 距離像素 / 像素每公尺

# 計算速度
時間差 = 當前時間 - 前一個時間
速度 = 距離公尺 / 時間差
```

2. 數據儲存
   - 使用 deque 進行高效的歷史記錄追蹤
   - 實現分開的歷史記錄：
     - 手掌速度
     - 手肘速度
     - 角度
     - 時間點

### 2.6 關鍵學習
1. 單位轉換在計算中的重要性
2. 分開追蹤不同關節的價值
3. 複雜數據清晰視覺化的需求
4. 準確校正的重要性
5. 完整數據記錄和分析的效益

### 2.7 最佳實踐
1. 始終驗證單位轉換
2. 為不同測量維持分開的追蹤
3. 提供清晰的視覺回饋
4. 保持詳細的分析報告
5. 使用一致的命名規則
6. 實現適當的錯誤處理
7. 維護清晰的文檔

### 2.8 最近更新的問題與解決方法

1. **整合最大手腕速度到報告**
   - 問題：需要將 `ArmAxisTracker` 的 `wrist_speed_history` 數據整合到文字報告中，並計算最大手腕速度。
   - 解決方法：
     - 在 `export_charts_and_report` 函數中，新增邏輯以檢查 `wrist_speed_history` 是否為空。
     - 若不為空，計算最大值並將其加入報告。
     - 若為空，則在報告中顯示適當的提示訊息。
   - 測試：
     - 使用多組數據進行測試，確認報告生成正確且無錯誤。

2. **移除即時顯示功能**
   - 問題：需要從 `arm_speed_video_analysis.py` 中移除即時顯示速度、角度等統計數據的功能，但保留軌跡繪製。
   - 解決方法：
     - 刪除與即時顯示相關的代碼。
     - 確保軌跡繪製功能不受影響，並進行必要的代碼重構。
   - 測試：
     - 驗證軌跡繪製功能是否正常運作。
     - 確保刪除即時顯示後，程式執行無誤。

3. **測試與驗證**
   - 問題：需要確保所有更改不會影響現有功能，並正確生成報告。
   - 解決方法：
     - 使用多組影片進行測試，檢查報告生成的準確性。
     - 驗證軌跡繪製是否與預期一致。
   - 測試結果：
     - 所有測試均通過，報告生成正確，軌跡繪製無異常。

4. **文檔更新**
   - 問題：需要記錄所有遇到的問題和解決方法，確保開發過程透明且可追溯。
   - 解決方法：
     - 在 `learning.md` 中新增一節，詳細記錄最近的問題與解決方法。
   - 測試：
     - 確認文檔內容完整且清晰，便於未來參考。

## 3. 技術細節

### 3.1 骨架偵測
```python
self.pose = self.mp_pose.Pose(
    static_image_mode=False,
    model_complexity=1,
    smooth_landmarks=True,
    min_detection_confidence=0.5,
    min_tracking_confidence=0.5
)
```
- 使用 MediaPipe Pose 模型
- 啟用平滑處理
- 設定適當的偵測和追蹤閾值

### 3.2 速度計算
```python
distance = math.sqrt((shoulder[0] - prev_shoulder[0])**2 + 
                    (shoulder[1] - prev_shoulder[1])**2)
time_diff = timestamp - self.time_history[-1]
speed = distance / time_diff
```
- 使用歐幾里得距離計算位移
- 考慮時間差計算速度
- 使用 deque 儲存歷史數據

### 3.3 角度計算
```python
v1 = (elbow[0] - shoulder[0], elbow[1] - shoulder[1])
v2 = (wrist[0] - elbow[0], wrist[1] - elbow[1])
dot_product = v1[0] * v2[0] + v1[1] * v2[1]
angle = math.degrees(math.acos(cos_angle))
```
- 使用向量點積計算角度
- 考慮向量大小
- 確保角度在有效範圍內

### 3.4 數據視覺化
```python
plt.figure(figsize=(12, 6))
plt.plot(self.time_history, self.speed_history, 'b-', label='手軸移動速度')
plt.title(f'手軸移動速度分析\n'
         f'最大速度: {max_speed:.2f} m/s | 平均速度: {avg_speed:.2f} m/s')
```
- 使用 Matplotlib 繪製圖表
- 添加統計資訊
- 優化圖表格式

## 4. 未來改進方向

### 4.1 功能擴展
- 添加更多運動分析指標
- 實現多角度分析
- 添加運動模式識別

### 4.2 效能優化
- 實現多執行緒處理
- 優化記憶體使用
- 提高即時處理能力

### 4.3 使用者體驗
- 改進使用者介面
- 添加更多互動功能
- 優化錯誤提示

## 5. 使用說明

### 5.1 基本操作
- 載入影片：輸入影片路徑
- 播放控制：
  - 空白鍵：暫停/繼續
  - r：重置
  - s：開始/停止記錄
  - e：匯出報告
  - [：減慢速度
  - ]：加快速度
  - ESC：退出

### 5.2 注意事項
- 確保影片格式支援
- 保持適當的拍攝距離
- 確保光線充足
- 避免快速移動

## 6. 常見問題

### 6.1 影片載入問題
- 檢查檔案路徑
- 確認檔案格式
- 檢查檔案權限

### 6.2 偵測問題
- 調整光線條件
- 確保完整的身體可見
- 避免過快移動

### 6.3 效能問題
- 降低影片解析度
- 關閉其他程式
- 使用較好的硬體設備

## 7. 腿部角度分析開發紀錄

### 7.1 問題與解決
1. **膝關節角度偏小**
   - 問題：自然站立時膝關節角度僅約160度，低於預期的170~180度。
   - 原因：
     - MediaPipe 偵測點在膝、髖、踝的定位有系統性誤差。
     - 拍攝角度非正側面，三維向量投影誤差。
     - 人體姿勢或衣著影響 landmark 偵測。
   - 解決：
     - 加入角度校正常數（+15度），讓顯示更貼近實際。
     - 經測試發現正側面拍攝時角度較準確，最終移除校正常數，回復原始計算。

2. **數據文字報告**
   - 新增匯出每一幀右膝、左膝角度與角速度的文字報告，方便後續分析。

### 7.2 技術細節
- 使用 MediaPipe Pose 偵測人體骨架點。
- 膝關節角度計算：以大腿（髖→膝）與小腿（踝→膝）向量的夾角，打直時接近180度，彎曲時小於180度。
- 角速度計算：連續角度差除以時間差。
- 支援影片載入、即時顯示、圖表與文字報告匯出。
- 可彈性調整或移除角度校正常數。

### 7.3 實務建議
- 自然站立時膝關節角度約170~175度，完全伸展時接近180度。
- 若發現角度普遍偏小，應優先檢查拍攝角度與 landmark 偵測，再考慮校正。
- 報告中可註明系統性誤差來源。